<html>
<head>
	<title>Transients Stream</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="{{ static_url('jquery-ui-1.11.4.custom/jquery-ui.min.css') }}" />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="{{ static_url('js/timeago.js') }}"></script>

	<script>

			// two audio elements, one to load the next file
			var audioDecks;

			// two playlists: one for unplayed, one for played
			var unplayedList = [];
			var playedList = [];

			// is this necessary?
			var deckIndex = 0;

			// var apiURL = "xn--vg8hjj.ws";
			var apiURL = 'localhost:9000';

			// coordinates
			var coords = {};

			// playlist object class / data
			var playlistObject = function(data) {
				this._id = data._id;
				this.loc = data.loc;
				this.src = data.sound_url_mp3;
				this.liked = false;
				this.played = false;
				this.cued = false;
			}

			// clear audio decks if they exist, otherwise create them
			function resetAudioDecks() {
				if (audioDecks) {
					audioDecks.forEach(function(deck) {
						deck.stop();
					});
				}
				else {
					audioDecks = [new Audio(), new Audio(), new Audio(), new Audio(), new Audio(), new Audio()];
					audioDecks.forEach( function(deck, index) {

						deck.addEventListener("ended",function() {

							// pop lastPlayed onto playedList
							var lastPlayed = unplayedList.splice(0, 1);
							playedList.push(lastPlayed);

							// cueNext
							if (unplayedList.length > 0) {
								cueNext(index);
							} else {
								console.log('no more sounds!');
							}
						});
					})
				}
			}

			window.onload = function() {
				resetAudioDecks();
				navigator.geolocation.getCurrentPosition(locationSuccess, locationError);
			};

			function loadSounds(limit, lat, lng) {
				$.getJSON('http://' + apiURL + '/nearbysounds?limit=' + limit + '&lat=' + lat + '&lng='+lng, function(data) {

					data.geosounds.forEach(function(geosound) {
						unplayedList.push( new playlistObject( geosound) );
					});

					cueDecks(unplayedList);
				});
			}


			function cueDecks(_unplayedList) {
				var uIndex = 0;

				var emptyDecks = audioDecks.filter(function(item) {
					return !item.src || item.ended == true;
				});

				emptyDecks.forEach(function(deck) {
					while (_unplayedList[uIndex].cued) {
						uIndex++;
					}
					deck.src = _unplayedList[uIndex].src;
					deck.load();
					_unplayedList[uIndex].cued = true;
					uIndex++;
				});

				emptyDecks[0].play();
				return;
			}

			function cueNext(deckIndex) {
				var deck = audioDecks[deckIndex];
				deck.src = unplayedList[0].src;
				unplayedList[0].cued = true;

				// play next
				var nextDeck = audioDecks[ deckIndex++ % audioDecks.length ];
				nextDeck.play();
			}

			function locationSuccess(pos) {
				coords.lat = pos.coords.latitude;
				coords.lng = pos.coords.longitude;
				loadSounds(20, coords.lat, coords.lng);
			}

			function locationError(err) {
				console.log(err);
			}

	</script>

</head>

<body>

	<div class="now-playing container">
		<h1 id="description"></h1>
		<h1 id="datetime"></h1>

	</div>


</body>

</html>

