<html>
<head>
	<title>Transients Map</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="{{ static_url('css/leaflet.css') }}" />

	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

</head>

<body>
  <div id="map" style="width: 100%; height: 100%;"></div>

	<script src="{{ static_url('js/leaflet.js') }}"></script>

	<script>
		var map;
		var circles = [];
		var userLocation = [42.92916, -33.98037984042799]; // NYC default

		// load the map
		window.onload = function() {
			console.log('doc ready');
			initMap(userLocation);
		};

		// center map if user gives location
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition( setUserLocation );
		}

		// set the user location, then center the map
		function setUserLocation(loc) {
			userLocation = [loc.coords.latitude, loc.coords.longitude];
			centerMap(userLocation);
		}

		function centerMap(loc) {
			map.setView(loc, 13);


			// temporary fun: use bounds to set random drift amount range
			var bounds = map.getBounds();
			var latMin = bounds._southWest.lat;
			var latMax = bounds._northEast.lat;
			var lngMin = bounds._southWest.lng;
			var lngMax = bounds._northEast.lng;

			for (var i = 0; i < circles.length; i++) {
				var circle = circles[i];
				circle.velocity.lat = Math.random() * (latMax - latMin) /2000;
				circle.velocity.lng = Math.random() * (lngMax - lngMin) /2000;
			}


		}

		// center the map to any location [lat, lng]
		function initMap(loc) {
			map = L.map('map').setView(loc, 13);

			L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={{mapbox_public_key}}', {
				attribution: 'Map Data!',
				maxZoom: 18,
				id: 'transients.de92d381',
				accessToken: '{{mapbox_public_key}}'
			}).addTo(map);

		}


		//receive locations
		var locations = []; 

		$.getJSON('http://ec2-52-24-91-31.us-west-2.compute.amazonaws.com:9000/geosounds', function(data) {
			locations = data['geosounds'];
			console.log(locations);


			for (i = 0; i < locations.length; i++) {
				var lat = locations[i]['latitude'];
				var lng = locations[i]['longitude'];
				var pos = [lat, lng];

				var circle = L.circle( pos, 50, {
					color: 'red',
					fillColor: '#f03',
					fillOpacity: 0.5
				}).addTo(map);

				circle.bindPopup("<audio src='" + locations[i]['sound_url'] + "' preload=''auto' controls><audio>");

				// give each circle a soundURL
				circle.soundURL = locations[i]['sound_url'];

				circle.velocity = {
					lat: 0.00001,
					lng: 0.00001
				};

				// is this needed?
				circles.push(circle);
			}

		});


		// animate the circles
		var start = 0;

		function step(timestamp) {
			var bounds = map.getBounds();
			var latMin = bounds._southWest.lat;
			var latMax = bounds._northEast.lat;
			var lngMin = bounds._southWest.lng;
			var lngMax = bounds._northEast.lng;

			if (circles.length > 0) {
				for (var i = 0; i < circles.length; i++) {
					var c = circles[i];

					map.removeLayer(circles[i]);
					c._latlng.lat += c.velocity.lat;
					c._latlng.lng += c.velocity.lng;

					// border checking
					if (c._latlng.lat > latMax || c._latlng.lat < latMin) {
						c.velocity.lat *= -1;
					}
					if (c._latlng.lng > lngMax || c._latlng.lng < lngMin) {
						c.velocity.lng *= -1;
					}

					map.addLayer(c);
				}
			}
			window.requestAnimationFrame(step);
		}
		window.requestAnimationFrame(step);

	</script>


</body>
</html>

<!--
	research:
	 http://zevross.com/blog/2014/09/30/use-the-amazing-d3-library-to-animate-a-path-on-a-leaflet-map/
-->